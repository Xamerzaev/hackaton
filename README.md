# Описание приложения "Way Gulam"

![Way Gulam](https://imageup.ru/img36/4605910/telegram-cloud-photo-size-2-5348493559797501315-y.jpg)

Way Gulam - это приложение, разработанное для облегчения поиска и получения информации о мероприятиях, проходящих на территории Чеченской республики и в дальнейшем за ее пределами. Все API-точки приложения доступны в Swagger по адресу: [http://127.0.0.1:8000/_platform/docs/v1/swagger/](http://127.0.0.1:8000/_platform/docs/v1/swagger/).

## О проекте "Way Gulam"

### Безопасность

Приложение "Way Gulam" обладает множеством технологий для обеспечения безопасности. Вот некоторые из них:

- CSRF токены: Защита от атак межсайтовой подделки запроса (CSRF).
- Межсайтовый скриптинг (XSS): Меры для предотвращения атак межсайтового скриптинга.
- SQL инъекции: Защита от атак, связанных с внедрением SQL-кода.
- Django Axes: Мониторинг и защита от атак на подбор паролей и других подозрительных действий.
- Зашифрованные пароли: Хранение паролей в зашифрованном виде для обеспечения безопасности пользовательских учетных записей.

### Структура приложения

Все приложения располагаются в папке `powerbank/apps`. Проект использует собственную команду `startapp`, см. `powerbank/management/commands/startapp.py` для дополнительной информации.

Эта команда инициализирует новое приложение со следующими элементами:

- Директория `models`, вместо общего файла `models.py`, что позволяет разделять модели по их предназначению и поддерживает чистоту проекта.
- Директория `views`, соответствующая вышеуказанному принципу разделения.
- Директория `serializers`, также соответствующая вышеуказанному принципу.

Другие файлы и папки подобны тем, которые создает Django (`admin.py`, `apps.py`).

Эта команда гарантирует, что приложения добавляются в папку `apps` и инициализируются в соответствии с настройками проекта. Чтобы добавить новое приложение, выполните следующую команду:

```bash
$ python manage.py startapp <app_name>
```

Затем включите приложение в список `INSTALLED_APPS` в файле `config/base.py`, следуя такому образу:

```python
INSTALLED_APPS = [
    ...
    'powerbank.apps.<app_name>.apps.<app_name_capitalized>Config',
    ...
]
```

Например, если имя вашего приложения - "foo", то это будет выглядеть так:

```python
INSTALLED_APPS = [
    ...
    'powerbank.apps.foo.apps.FooConfig',
    ...
]
```

Рекомендуется всегда включать полную конфигурацию при добавлении приложения в список `INSTALLED_APPS`. Это поддерживает последовательность при использовании сигналов.

### Настройки

Проект использует [`django-configurations`](https://django-configurations.readthedocs.io/en/stable/) для классовых настроек. В проекте доступны две конфигурации: `Dev` и `Prod`. Основные настройки находятся в файле `config/base.py`, `Dev` - в файле `config/dev.py`, а `Prod` - в файле `config/prod.py`.

Вы можете использовать переменную окружения `DJANGO_CONFIGURATION` для переключения между конфигурациями. Настройки `Dev` используются по умолчанию.

### Переменные окружения

Большинство конфигураций в проекте зависят от переменных окружения. У вас есть несколько способов использовать их:

- Задать их в файле `.env` в корне проекта, там, где находится этот файл `README.md`. Вы можете обратиться к `.env.template` для доступных вариантов и легко создать файл конфигурации, используя этот шаблон.
- Задать их непосредственно через переменные окружения.
- Задать их во время выполнения docker / kubernetes с использованием файла `.env`. Большинство настроек остаются такими же, за исключением того, что вам нужно будет избавиться от комментариев в `.env.template` при создании файла `.env`.

Вы по-прежнему можете запустить проект без создания любых из этих файлов, так как по умолчанию имеются настройки для большинства требуемых параметров. Однако вам нужно будет настроить экземпляры БД, RabbitMQ (если вы планируете использовать Celery) и убедиться, что настройки соответствуют настройкам, используемым по умолчанию в конфигурациях. Рекомендуется всегда иметь файл `.env`, управляющий этими настройками.

**Примечание**: Значения для `POWERBANK_PASSWORD_RESET_URL` и `POWERBANK_EMAIL_VERIFICATION_URL` должны быть установлены для корректной работы сброса

 пароля и подтверждения по электронной почте. Они гарантируют, что перенаправление происходит на URL-адреса веб-интерфейса для сброса пароля и подтверждения адреса электронной почты.

### Документация

В проекте используется `drf-yasg` для автоматического создания документации для API-точек, но созданная документация не всегда идеальна, поэтому в этом проекте используется собственная схема для управления документацией.

Детали для каждой точки API управляются с использованием класса. Например, приложение `accounts` поддерживает обновление профиля, и для управления документацией этой точки используется класс `ProfileUpdate`. Он выглядит примерно так:

```python
class ProfileUpdate:
    desc = f"""
    Profile Update - это API-точка для обновления профиля, связанного с определенным пользователем.

    Используя эту точку, вы можете отправить запрос на обновление профиля пользователя. Следующие поля могут быть обновлены: {fields_to_md(ProfileCreateUpdateSerializer.fields_names)}
    """  # noqa

    responses = {
        "200": openapi.Response(
            description="OK",
            examples=profile_update_200_example,
            schema=UserInfoSerializer,
        ),
        "401": openapi.Response(
            description="Unauthorized", examples=profile_update_401_example
        ),
        "403": openapi.Response(
            description="Permission Denied",
            examples=profile_update_403_example,
        ),
    }

    code_examples = [{"lang": "Bash", "source": profile_update_curl}]

    swagger_setup = {
        "operation_id": "Profile Update",
        "operation_description": desc,
        "request_body": ProfileCreateUpdateSerializer,
        "responses": responses,
        "code_examples": code_examples,
    }
```

Примеры берутся из `config/examples` и выглядят примерно так:

```python
profile_update_200_example = {
    "application/json": {
        "id": 1,
        "name": "Тестовый пользователь",
        "profile_pic": "/some_pic.jpg"
    },
}

profile_update_401_example = {
    "application/json": {
        "error": "NotAuthenticated",
        "detail": "Неверные учетные данные.",  # noqa
    }
}

profile_update_403_example = {
    "application/json": {
        "error": "PermissionDenied",
        "detail": "У вас нет разрешения на выполнение этого действия."
    }
}
```

После настройки класса вы можете использовать декоратор `swagger_auto_schema` для внедрения спецификации в представление.

```python
@method_decorator(
    swagger_auto_schema(**ProfileUpdate.swagger_setup), "partial_update"
)
class ProfileViewSet(UpdateModelMixin, PsqMixin, GenericViewSet):
    ...
```

В приведенном выше примере класс `ProfileUpdate`, который мы ранее определили, используется для добавления этих настроек к действию `partial_update`.

### Представления

Проект настроен на использование [`GenericViewSet`](https://www.django-rest-framework.org/api-guide/viewsets/#genericviewset). Он также использует различные [`mixins`](https://www.django-rest-framework.org/api-guide/generic-views/#mixins) для предоставления действий `create`, `retrieve`, `update` и `destroy`. Вы можете настроить пользовательские действия для любых других операций, которые вам могут понадобиться.

Представления также используют [`PsqMixin`](https://github.com/drf-psq/drf-psq#1-psqmixin-class) для настройки различных сериализаторов и разрешений для действий. Сериализаторы берутся из директории `serializers`, а разрешения - из директории `permissions` (или файла, на ваше усмотрение).

### Роутеры

`GenericViewSet` автоматически настраивает URL на основе используемых смешанных классов. Он также добавляет пользовательские действия в виде URL. Поэтому у нас есть `urls/versioned_urls.py`, который использует [`SimpleRouter`](https://www.django-rest-framework.org/api-guide/routers/#simplerouter) для добавления этих представлений и их размещения по разным конечным точкам.

### Версионирование

Версия берется из переменных окружения, вы можете настроить ее в файле `.env`. Чтобы добавить и поддерживать разные версии, вы можете иметь разные списки `urls` в файле `urls/versioned_urls.py`. Затем обновите окружение, чтобы по умолчанию использовалась последняя версия. Вы можете вручную включать другие версии в файле `urls/__init__.py`, по мере необходимости.

### База данных

Проект поддерживает PostgreSQL, PostGIS, MySQL, MySQL (GIS), Oracle, Oracle (GIS), Redshift, CockroachDB и SQLite. Вы можете обратиться к [этой таблице](https://github.com/jazzband/dj-database-url#url-schema) для получения информации о том, как формировать URL-адрес для вашей базы данных.